# NewLife.MySql

[![NuGet](https://img.shields.io/nuget/v/NewLife.MySql.svg)](https://www.nuget.org/packages/NewLife.MySql)
[![License](https://img.shields.io/github/license/NewLifeX/NewLife.MySql)](https://github.com/NewLifeX/NewLife.MySql/blob/master/LICENSE)

**NewLife.MySql** æ˜¯æ–°ç”Ÿå‘½å›¢é˜Ÿï¼ˆNewLifeï¼‰å‡ºå“çš„**çº¯å›½äº§é«˜æ€§èƒ½ MySQL é©±åŠ¨**ï¼ŒåŸºäº ADO.NET æ ‡å‡†æ¥å£å®ç°ï¼Œç›´æ¥é€šè¿‡ TCP é€šä¿¡å®ç° MySQL åè®®å±‚ï¼ˆProtocol Version 10ï¼‰ï¼Œå®Œå…¨ä¸ä¾èµ– NewLife å›¢é˜Ÿä»¥å¤–çš„ä»»ä½•ç¬¬ä¸‰æ–¹ç»„ä»¶ï¼Œé‡‡ç”¨ **MIT å¼€æºåè®®**ã€‚

ä»…ä¾èµ– `NewLife.Core`ï¼ˆåŒä¸ºæ–°ç”Ÿå‘½å›¢é˜Ÿå‡ºå“ï¼‰ï¼Œå®ç°äº†ä¸€ä¸ª**é›¶ç¬¬ä¸‰æ–¹ä¾èµ–**ã€**å…¨é“¾è·¯çœŸå¼‚æ­¥**ã€**æ”¯æŒå¤§æ•°æ®æ‰¹é‡æ“ä½œ**çš„çº¯æ‰˜ç®¡ MySQL å®¢æˆ·ç«¯ã€‚

## è®¾è®¡ç›®æ ‡

- **è½»é‡æç®€**ï¼šåªåš ADO.NET æ ‡å‡†çš„å¢åˆ æ”¹æŸ¥ã€äº‹åŠ¡ã€å‚æ•°åŒ–æŸ¥è¯¢ã€å­˜å‚¨è¿‡ç¨‹å’Œæ‰¹é‡æ“ä½œï¼Œä¸è¿½æ±‚å¤§è€Œå…¨
- **é«˜æ€§èƒ½**ï¼šé›¶é¢å¤–å†…å­˜åˆ†é…ï¼ˆ`ArrayPool` / `OwnerPacket`ï¼‰ã€çœŸå¼‚æ­¥ IOã€ç®¡é“åŒ–æ‰¹é‡æ‰§è¡Œ
- **çº¯å›½äº§**ï¼šæ ¸å¿ƒä»£ç å®Œå…¨è‡ªä¸»å¯æ§ï¼Œæ—  GPL è®¸å¯é£é™©ï¼Œé€‚åˆå›½äº§åŒ–æ›¿ä»£åœºæ™¯
- **å¤§æ•°æ®å‹å¥½**ï¼šå†…ç½®å¤šç§æ‰¹é‡æ“ä½œæ–¹æ¡ˆï¼ˆå­—å…¸å‚æ•°é›† / æ•°ç»„ç»‘å®š / ç®¡é“åŒ– / å¤šè¡Œ VALUES / DbBatchï¼‰ï¼Œè¦†ç›–ä¸‡çº§åˆ°ç™¾ä¸‡çº§è¡Œæ“ä½œ
- **å¹¿æ³›å…¼å®¹**ï¼šæ”¯æŒ `net45` ~ `net10` å…¨ç‰ˆæœ¬ï¼ŒMySQL 5.x ~ 9.0+ å…¨ç³»åˆ—

## æ ¸å¿ƒåŠŸèƒ½

| åŠŸèƒ½ | è¯´æ˜ |
|------|------|
| è¿æ¥ç®¡ç† | æ”¯æŒ MySQL 5.x / 8.0 / 9.0+ï¼Œ`mysql_native_password` å’Œ `caching_sha2_password` åŒè®¤è¯ |
| æŸ¥è¯¢æ‰§è¡Œ | `ExecuteReader` / `ExecuteScalar` / `ExecuteNonQuery`ï¼Œå®Œæ•´ ADO.NET æ¥å£ |
| å‚æ•°åŒ–æŸ¥è¯¢ | å®¢æˆ·ç«¯å‚æ•°æ›¿æ¢ï¼Œ`@å‚æ•°å` è¯­æ³•ï¼Œè‡ªåŠ¨è½¬ä¹‰é˜²æ³¨å…¥ |
| é¢„ç¼–è¯‘è¯­å¥ | `Prepare()` èµ° `COM_STMT_PREPARE` äºŒè¿›åˆ¶åè®®ï¼Œå¯é€‰ `UseServerPrepare` å…¨å±€å¼€å…³ |
| æ‰¹é‡æ“ä½œ | `ExecuteBatch`ï¼ˆå­—å…¸å‚æ•°é›†ï¼‰/ `ExecuteArrayBatch`ï¼ˆOracle æ•°ç»„ç»‘å®šï¼‰/ ç®¡é“åŒ– / å¤šè¡Œ VALUES / DbBatch |
| ç®¡é“åŒ–æ‰§è¡Œ | `Pipeline=true` æ‰¹é‡å‘é€åæ‰¹é‡æ¥æ”¶ï¼Œç½‘ç»œå»¶è¿Ÿä»…ä¸€æ¬¡ï¼Œä¸‡çº§è¡Œæ€§èƒ½æå‡ 3~10Ã— |
| äº‹åŠ¡æ”¯æŒ | `BeginTransaction` / `Commit` / `Rollback`ï¼Œå››ç§éš”ç¦»çº§åˆ«ï¼Œè‡ªåŠ¨å›æ»š |
| å­˜å‚¨è¿‡ç¨‹ | `CommandType.StoredProcedure`ï¼Œæ”¯æŒ IN/OUT å‚æ•° |
| SSL/TLS | `SslMode=Preferred/Required`ï¼Œæ”¯æŒ TLS 1.2/1.3 |
| è¿æ¥æ±  | é»˜è®¤å¼€å¯ï¼ŒæŒ‰è¿æ¥å­—ç¬¦ä¸²åˆ†æ± ï¼Œè‡ªåŠ¨å¥åº·æ£€æŸ¥ä¸å›æ”¶ |
| å¼‚æ­¥æ–¹æ³• | å…¨é“¾è·¯ `async/await`ï¼Œ`OpenAsync` / `ExecuteReaderAsync` / `ReadAsync` ç­‰ |
| Schema æŸ¥è¯¢ | Tables / Columns / Indexes / Databases ç­‰å…ƒæ•°æ® |
| DbBatch | .NET 6+ ADO.NET æ ‡å‡†æ‰¹é‡ API |
| XCode é›†æˆ | é€šè¿‡ `MySqlClientFactory` è‡ªåŠ¨æ³¨å†Œï¼Œæ— ç¼å¯¹æ¥ XCode ORM |

## äº®ç‚¹ç‰¹æ€§

### ğŸš€ çœŸç®¡é“åŒ–æ‰¹é‡æ‰§è¡Œï¼ˆPipelineï¼‰

ç‹¬åˆ›çš„ç®¡é“åŒ–æ‰§è¡Œæ¨¡å¼ï¼ŒåŸºäº `COM_STMT_PREPARE + COM_STMT_EXECUTE` äºŒè¿›åˆ¶åè®®ï¼š

- **Phase 1**ï¼šæ‰¹é‡æ„å»ºå¹¶å‘é€æ‰€æœ‰ EXECUTE åŒ…åˆ°ç½‘ç»œç¼“å†²åŒºï¼Œä»…æœ€åä¸€ä¸ªåŒ… Flush
- **Phase 2**ï¼šæŒ‰é¡ºåºæ‰¹é‡è¯»å–æ‰€æœ‰ OK/Error å“åº”ï¼Œç´¯åŠ å½±å“è¡Œæ•°
- **åŸç†**ï¼šTCP åè®®æ ˆåˆå¹¶å°åŒ…ä¸ºå¤§åŒ…ï¼ˆNagle ç®—æ³•ï¼‰ï¼Œç½‘ç»œå¾€è¿”ä»…ä¸€æ¬¡

| åœºæ™¯ | ä¸²è¡Œæ¨¡å¼ | ç®¡é“åŒ–æ¨¡å¼ | æå‡ |
|------|---------|-----------|------|
| 1000 è¡Œ INSERTï¼ˆå†…ç½‘ï¼‰ | ~1s | ~0.3s | **3Ã—** |
| 10000 è¡Œ INSERTï¼ˆè·¨æœºæˆ¿ï¼‰ | ~30s | ~3s | **10Ã—** |

### ğŸ”§ å¤šç§æ‰¹é‡æ“ä½œæ–¹æ¡ˆ

| æ–¹æ¡ˆ | API | é€‚ç”¨åœºæ™¯ |
|------|-----|---------|
| å­—å…¸å‚æ•°é›† | `ExecuteBatch` | åŠ¨æ€å‚æ•°ï¼Œå‚æ•°æ¥è‡ªé›†åˆ |
| æ•°ç»„ç»‘å®š | `ExecuteArrayBatch` | å¤§æ‰¹é‡ DMLï¼ŒOracle é£æ ¼ |
| ç®¡é“åŒ– | `Pipeline=true` | ä¸‡çº§/åä¸‡çº§è¡Œï¼Œè·¨æœºæˆ¿ |
| å¤šè¡Œ VALUES | æ‹¼æ¥ SQL | çº¯ INSERT æ‰¹é‡ |
| DbBatch (.NET 6+) | `CreateBatch` | ä¸åŒ SQL æ··åˆæ‰¹é‡ |

### ğŸ›¡ï¸ é›¶ç¬¬ä¸‰æ–¹ä¾èµ–

- ä»…ä¾èµ– `NewLife.Core`ï¼ˆåŒä¸º NewLife å›¢é˜Ÿå‡ºå“ï¼‰ï¼Œæ— ä»»ä½•å¤–éƒ¨ç¬¬ä¸‰æ–¹åº“
- æ—  GPL è®¸å¯é£é™©ï¼ŒMIT åè®®ï¼Œå•†ç”¨æ— å¿§
- é€‚åˆå›½äº§åŒ–æ›¿ä»£ã€ä¿¡åˆ›ç¯å¢ƒã€å®‰å…¨å®¡è®¡ä¸¥æ ¼çš„åœºæ™¯

### âš¡ æè‡´æ€§èƒ½ä¼˜åŒ–

- **é›¶é¢å¤–åˆ†é…**ï¼šä½¿ç”¨ `ArrayPool<T>` å’Œ `OwnerPacket` ç®¡ç†å†…å­˜ï¼Œå‡å°‘ GC å‹åŠ›
- **å¯¹è±¡æ± å¤ç”¨**ï¼š`Pool.StringBuilder` / `Pool.MemoryStream` / `Pool.Shared` å…¨é¢æ± åŒ–
- **çœŸå¼‚æ­¥ IO**ï¼šå…¨é“¾è·¯ `async/await`ï¼Œæ—  `sync-over-async` åæ¨¡å¼
- **ç²¾ç®€åè®®è§£æ**ï¼šåªè§£æå¿…è¦å­—æ®µï¼Œè·³è¿‡å†—ä½™æ•°æ®ï¼Œæœ€å°åŒ– CPU å¼€é”€

### ğŸŒ å¹¿æ³›å…¼å®¹æ€§

- **ç›®æ ‡æ¡†æ¶**ï¼š`net45` / `net461` / `netstandard2.0` / `netstandard2.1` / `net6.0` / `net10.0`
- **MySQL ç‰ˆæœ¬**ï¼š5.5 ~ 9.0+ï¼Œæ”¯æŒ `mysql_native_password` å’Œ `caching_sha2_password`
- **æ¡ä»¶ç¼–è¯‘**ï¼šé’ˆå¯¹ä¸åŒæ¡†æ¶è‡ªåŠ¨é€‰æ‹©æœ€ä¼˜å®ç°ï¼ˆå¦‚ TLS 1.3 ä»… .NET 5.0+ï¼‰

## ä¸ä¸»æµ MySQL é©±åŠ¨å¯¹æ¯”

### åŠŸèƒ½å¯¹æ¯”

| åŠŸèƒ½ | NewLife.MySql | MySqlConnector | MySql.Data (Oracle) |
|------|:------------:|:--------------:|:-------------------:|
| **è®¸å¯åè®®** | **MIT** | MIT | GPL (å•†ç”¨éœ€ä»˜è´¹) |
| **å›½äº§è‡ªä¸»** | âœ… å®Œå…¨è‡ªä¸» | âŒ | âŒ |
| **ç¬¬ä¸‰æ–¹ä¾èµ–** | **æ— **ï¼ˆä»… NewLife.Coreï¼‰ | æ—  | æ—  |
| **çº¯æ‰˜ç®¡å®ç°** | âœ… | âœ… | âœ… |
| **çœŸå¼‚æ­¥ IO** | âœ… | âœ… | âŒ (sync-over-async) |
| **è¿æ¥æ± ** | âœ… è‡ªåŠ¨åˆ†æ±  | âœ… | âœ… |
| **å‚æ•°åŒ–æŸ¥è¯¢** | âœ… å®¢æˆ·ç«¯æ›¿æ¢ | âœ… å®¢æˆ·ç«¯/æœåŠ¡ç«¯ | âœ… å®¢æˆ·ç«¯æ›¿æ¢ |
| **é¢„ç¼–è¯‘è¯­å¥** | âœ… Prepare/Execute | âœ… | âœ… |
| **å­˜å‚¨è¿‡ç¨‹** | âœ… IN/OUT å‚æ•° | âœ… | âœ… |
| **äº‹åŠ¡** | âœ… 4ç§éš”ç¦»çº§åˆ« | âœ… | âœ… |
| **SSL/TLS** | âœ… TLS 1.2/1.3 | âœ… | âœ… |
| **mysql_native_password** | âœ… | âœ… | âœ… |
| **caching_sha2_password** | âœ… | âœ… | âœ… |
| **ç®¡é“åŒ–æ‰¹é‡æ‰§è¡Œ** | âœ… **ç‹¬åˆ›** | âŒ | âŒ |
| **æ•°ç»„ç»‘å®šæ‰¹é‡** | âœ… Oracle é£æ ¼ | âŒ | âŒ |
| **å­—å…¸å‚æ•°é›†æ‰¹é‡** | âœ… | âŒ | âŒ |
| **DbBatch (.NET 6+)** | âœ… | âœ… | âŒ |
| **Schema æŸ¥è¯¢** | âœ… | âœ… | âœ… |
| **DataAdapter** | âœ… | âŒ | âœ… |
| **XCode ORM é›†æˆ** | âœ… åŸç”Ÿæ”¯æŒ | âŒ | âŒ |
| **å¤šç›®æ ‡æ¡†æ¶** | net45~net10 | netstandard2.0+ | net462+ |
| **MySQL 5.x~9.0** | âœ… | âœ… | âœ… |
| **MariaDB** | âœ… åŸºç¡€ | âœ… | âŒ |
| sha256_password | âŒ | âœ… | âœ… |
| ed25519 (MariaDB) | âŒ | âœ… | âŒ |
| DbDataSource (.NET 7+) | âŒ | âœ… | âŒ |
| EF Core æ”¯æŒ | âŒ (å®šä½è½»é‡) | âœ… (via Pomelo) | âœ… |
| å‹ç¼©åè®® | âŒ | âœ… | âœ… |
| è´Ÿè½½å‡è¡¡/æ•…éšœè½¬ç§» | âŒ | âœ… | âœ… |
| LOAD DATA LOCAL | âŒ | âœ… | âœ… |

### æ ¸å¿ƒä¼˜åŠ¿æ€»ç»“

| ç»´åº¦ | NewLife.MySql ä¼˜åŠ¿ |
|------|-------------------|
| **æ‰¹é‡æ€§èƒ½** | ç‹¬åˆ›ç®¡é“åŒ–æ‰§è¡Œ + æ•°ç»„ç»‘å®š + å­—å…¸å‚æ•°é›†ï¼Œå¤§æ•°æ®åœºæ™¯æ€§èƒ½é¢†å…ˆ |
| **è®¸å¯å®‰å…¨** | MIT åè®®ï¼Œæ—  GPL é£é™©ï¼Œå•†ç”¨å‹å¥½ |
| **å›½äº§è‡ªä¸»** | å®Œå…¨è‡ªä¸»å¯æ§ï¼Œé€‚åˆä¿¡åˆ›/å›½äº§åŒ–æ›¿ä»£ |
| **è½»é‡éƒ¨ç½²** | é›¶ç¬¬ä¸‰æ–¹ä¾èµ–ï¼ŒåŒ…ä½“ç§¯å° |
| **æ¡†æ¶å…¼å®¹** | æ”¯æŒ .NET Framework 4.5 åˆ° .NET 10ï¼Œè¦†ç›–æœ€å¹¿ |
| **XCode ç”Ÿæ€** | åŸç”Ÿé›†æˆ XCode ORMï¼Œå¼€ç®±å³ç”¨ |

## å®‰è£…

é€šè¿‡ NuGet å®‰è£…ï¼š

```
dotnet add package NewLife.MySql
```

æˆ–åœ¨é¡¹ç›®æ–‡ä»¶ä¸­æ·»åŠ å¼•ç”¨ï¼š

```xml
<PackageReference Include="NewLife.MySql" Version="1.0.*" />
```

## è¿æ¥å­—ç¬¦ä¸²

```
Server=localhost;Port=3306;Database=mydb;User Id=root;Password=pass;
```

æ”¯æŒçš„å‚æ•°ï¼š

| å‚æ•° | åˆ«å | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|--------|------|
| Server | DataSource, Data Source | - | æœåŠ¡å™¨åœ°å€ |
| Port | - | 3306 | ç«¯å£å· |
| Database | - | - | æ•°æ®åº“å |
| UserID | Uid, User Id, User | - | ç”¨æˆ·å |
| Password | Pass, Pwd | - | å¯†ç  |
| ConnectionTimeout | Connection Timeout | 15 | è¿æ¥è¶…æ—¶ï¼ˆç§’ï¼‰ |
| CommandTimeout | Default Command Timeout | 30 | å‘½ä»¤è¶…æ—¶ï¼ˆç§’ï¼‰ |
| SslMode | Ssl Mode | None | SSL æ¨¡å¼ï¼ˆNone/Preferred/Requiredï¼‰ |
| UseServerPrepare | Use Server Prepare | false | å‚æ•°åŒ–æŸ¥è¯¢æ˜¯å¦èµ°æœåŠ¡ç«¯é¢„ç¼–è¯‘ï¼ˆCOM_STMT_PREPARE/EXECUTE äºŒè¿›åˆ¶åè®®ï¼‰ |
| Pipeline | Pipelining | false | æ‰¹é‡æ“ä½œæ˜¯å¦å¯ç”¨çœŸç®¡é“åŒ–æ‰§è¡Œï¼ˆæ‰¹é‡å‘é€è¯·æ±‚åæ‰¹é‡æ¥æ”¶å“åº”ï¼Œå¤§å¹…å‡å°‘ç½‘ç»œå»¶è¿Ÿï¼‰ |

## å¿«é€Ÿå¼€å§‹

### æ‰“å¼€å’Œå…³é—­è¿æ¥

```csharp
using var conn = new MySqlConnection("Server=localhost;Database=mydb;User Id=root;Password=pass;");
conn.Open();

// ä½¿ç”¨è¿æ¥æ‰§è¡Œæ“ä½œ...
// using ç»“æŸæ—¶è‡ªåŠ¨å…³é—­å¹¶å½’è¿˜è¿æ¥æ± 
```

### æŸ¥è¯¢å¹¶è¯»å–ç»“æœé›†

```csharp
using var conn = new MySqlConnection(connStr);
conn.Open();

using var cmd = new MySqlCommand(conn, "SELECT id, name, age FROM users WHERE age > 18");
using var reader = cmd.ExecuteReader();

while (reader.Read())
{
    var id = reader.GetInt64(0);
    var name = reader.GetString(1);
    var age = reader.GetInt64(2);
    Console.WriteLine($"{id}: {name}, {age}");
}
```

### æŸ¥è¯¢å•ä¸ªå€¼

```csharp
using var cmd = new MySqlCommand(conn, "SELECT COUNT(*) FROM users");
var count = cmd.ExecuteScalar();
```

### æ‰§è¡ŒéæŸ¥è¯¢ï¼ˆINSERT/UPDATE/DELETEï¼‰

```csharp
using var cmd = new MySqlCommand(conn, "INSERT INTO users(name, age) VALUES('Tom', 25)");
var affectedRows = cmd.ExecuteNonQuery();

// å¿«æ·æ–¹å¼
var rows = conn.ExecuteNonQuery("DELETE FROM logs WHERE created < '2024-01-01'");
```

## å‚æ•°åŒ–æŸ¥è¯¢

ä½¿ç”¨ `@å‚æ•°å` è¯­æ³•ç»‘å®šå‚æ•°ï¼Œè‡ªåŠ¨è¿›è¡Œå€¼è½¬ä¹‰ï¼Œé˜²æ­¢ SQL æ³¨å…¥ï¼š

```csharp
using var cmd = new MySqlCommand(conn, "SELECT * FROM users WHERE name = @name AND age > @age");
cmd.Parameters.AddWithValue("name", "Tom");
cmd.Parameters.AddWithValue("age", 18);

using var reader = cmd.ExecuteReader();
while (reader.Read())
{
    Console.WriteLine(reader.GetString(0));
}
```

å‚æ•°åŒ–æ’å…¥ï¼š

```csharp
using var cmd = new MySqlCommand(conn, "INSERT INTO users(name, age, created) VALUES(@name, @age, @dt)");
cmd.Parameters.AddWithValue("name", "Alice");
cmd.Parameters.AddWithValue("age", 30);
cmd.Parameters.AddWithValue("dt", DateTime.Now);
var rows = cmd.ExecuteNonQuery();
```

NULL å€¼ä¼ é€’ï¼š

```csharp
cmd.Parameters.AddWithValue("email", DBNull.Value);
```

æ”¯æŒçš„å‚æ•°ç±»å‹ï¼š

| .NET ç±»å‹ | SQL å­—é¢é‡ç¤ºä¾‹ |
|-----------|---------------|
| `String` | `'hello'`ï¼ˆè‡ªåŠ¨è½¬ä¹‰ç‰¹æ®Šå­—ç¬¦ï¼‰ |
| `Int32` / `Int64` ç­‰æ•°å­— | `42` |
| `Boolean` | `1` æˆ– `0` |
| `DateTime` | `'2025-07-01 12:30:00'` |
| `Byte[]` | `X'CAFE'` |
| `Guid` | `'01234567-89ab-cdef-...'` |
| `Enum` | è½¬ä¸ºæ•°å­— |
| `null` / `DBNull.Value` | `NULL` |

## äº‹åŠ¡

```csharp
using var conn = new MySqlConnection(connStr);
conn.Open();

using var tr = conn.BeginTransaction();
try
{
    conn.ExecuteNonQuery("INSERT INTO orders(product, qty) VALUES('Widget', 10)");
    conn.ExecuteNonQuery("UPDATE inventory SET qty = qty - 10 WHERE product = 'Widget'");
    tr.Commit();
}
catch
{
    tr.Rollback();
    throw;
}
```

æ”¯æŒçš„éš”ç¦»çº§åˆ«ï¼š

```csharp
using var tr = conn.BeginTransaction(IsolationLevel.ReadCommitted);
```

- `ReadUncommitted`
- `ReadCommitted`
- `RepeatableRead`ï¼ˆMySQL é»˜è®¤ï¼‰
- `Serializable`

äº‹åŠ¡ `Dispose` æ—¶å¦‚æœæœªæäº¤ä¹Ÿæœªå›æ»šï¼Œä¼šè‡ªåŠ¨æ‰§è¡Œå›æ»šï¼š

```csharp
using (var tr = conn.BeginTransaction())
{
    conn.ExecuteNonQuery("INSERT INTO ...");
    // å¿˜è®° Commit/Rollback â€”â€” Dispose æ—¶è‡ªåŠ¨å›æ»š
}
```

## å­˜å‚¨è¿‡ç¨‹

é€šè¿‡ `CommandType.StoredProcedure` è°ƒç”¨å­˜å‚¨è¿‡ç¨‹ï¼Œæ”¯æŒè¾“å…¥/è¾“å‡ºå‚æ•°ï¼š

```csharp
using var cmd = new MySqlCommand { Connection = conn, CommandType = CommandType.StoredProcedure };
cmd.CommandText = "my_proc";
cmd.Parameters.AddWithValue("p_id", 1);

var outParam = new MySqlParameter { ParameterName = "p_result", Direction = ParameterDirection.Output };
cmd.Parameters.Add(outParam);

cmd.ExecuteNonQuery();
var result = outParam.Value; // è¾“å‡ºå‚æ•°å€¼
```

## é¢„ç¼–è¯‘è¯­å¥ï¼ˆPrepareï¼‰

é€šè¿‡ `Prepare()` åœ¨æœåŠ¡ç«¯é¢„ç¼–è¯‘ SQLï¼Œåç»­æ‰§è¡Œèµ°äºŒè¿›åˆ¶åè®®ï¼Œå‚æ•°æ— éœ€å®¢æˆ·ç«¯æ›¿æ¢ï¼š

```csharp
using var conn = new MySqlConnection(connStr);
conn.Open();

using var cmd = new MySqlCommand(conn, "INSERT INTO users(name, age) VALUES(@name, @age)");
cmd.Parameters.AddWithValue("name", "Tom");
cmd.Parameters.AddWithValue("age", 25);

// é¢„ç¼–è¯‘ï¼ˆæœåŠ¡ç«¯è§£æ SQLï¼Œè¿”å› statementIdï¼‰
cmd.Prepare();

// ç¬¬ä¸€æ¬¡æ‰§è¡Œ
cmd.ExecuteNonQuery();

// ä¿®æ”¹å‚æ•°åå†æ¬¡æ‰§è¡Œï¼ˆæ— éœ€é‡æ–°ç¼–è¯‘ï¼‰
cmd.Parameters[0].Value = "Jerry";
cmd.Parameters[1].Value = 30;
cmd.ExecuteNonQuery();
```

ä¹Ÿå¯ä»¥é€šè¿‡è¿æ¥å­—ç¬¦ä¸²å…¨å±€å¯ç”¨æœåŠ¡ç«¯é¢„ç¼–è¯‘ï¼Œæ‰€æœ‰å‚æ•°åŒ–æŸ¥è¯¢è‡ªåŠ¨èµ°äºŒè¿›åˆ¶åè®®ï¼š

```
Server=localhost;Database=mydb;User Id=root;Password=pass;UseServerPrepare=true;
```

## æ‰¹é‡æ“ä½œ

### æ–¹æ¡ˆ Aï¼šå­—å…¸å‚æ•°é›†ï¼ˆPrepare + Execute Ã— Nï¼‰

åŒä¸€ SQL ç»‘å®šå¤šç»„å‚æ•°æ‰§è¡Œï¼Œå†…éƒ¨è‡ªåŠ¨é¢„ç¼–è¯‘ï¼š

```csharp
using var cmd = new MySqlCommand(conn, "INSERT INTO users(name, age) VALUES(@name, @age)");
cmd.Parameters.AddWithValue("name", "");
cmd.Parameters.AddWithValue("age", 0);

var paramSets = new List<IDictionary<String, Object?>>
{
    new Dictionary<String, Object?> { ["name"] = "Alice", ["age"] = 25 },
    new Dictionary<String, Object?> { ["name"] = "Bob", ["age"] = 30 },
    new Dictionary<String, Object?> { ["name"] = "Charlie", ["age"] = 22 },
};
var totalAffected = cmd.ExecuteBatch(paramSets);
// æˆ–å¼‚æ­¥ç‰ˆæœ¬
var totalAffected2 = await cmd.ExecuteBatchAsync(paramSets);
```

### æ–¹æ¡ˆ Bï¼šOracle é£æ ¼æ•°ç»„ç»‘å®š

å‚æ•°å€¼è®¾ä¸ºæ•°ç»„ï¼ŒæŒ‡å®šæ‰§è¡Œæ¬¡æ•°ï¼Œç±»ä¼¼ Oracle çš„ ArrayBindCountï¼š

```csharp
using var cmd = new MySqlCommand(conn, "INSERT INTO users(name, age) VALUES(@name, @age)");
cmd.Parameters.AddWithValue("name", new[] { "Alice", "Bob", "Charlie" });
cmd.Parameters.AddWithValue("age", new[] { 25, 30, 22 });

var totalAffected = cmd.ExecuteArrayBatch(3);
// æˆ–å¼‚æ­¥ç‰ˆæœ¬
var totalAffected2 = await cmd.ExecuteArrayBatchAsync(3);
```

### æ–¹æ¡ˆ Cï¼šç®¡é“åŒ–æ‰§è¡Œ

é€šè¿‡è¿æ¥å­—ç¬¦ä¸²å¼€å¯ `Pipeline=true`ï¼Œå¯ç”¨çœŸç®¡é“åŒ–æ‰¹é‡æ‰§è¡Œã€‚åº•å±‚ä¼šå…ˆæ‰¹é‡å‘é€æ‰€æœ‰ COM_STMT_EXECUTE è¯·æ±‚åŒ…åˆ°ç½‘ç»œç¼“å†²åŒºï¼Œç„¶åæŒ‰é¡ºåºæ‰¹é‡è¯»å–å“åº”ã€‚ç½‘ç»œå¾€è¿”å»¶è¿Ÿä»…å‘ç”Ÿä¸€æ¬¡ï¼Œé€‚åˆå¤§æ‰¹é‡ DML åœºæ™¯ï¼ˆä¸‡çº§/åä¸‡çº§è¡Œï¼‰ï¼š

```
Server=localhost;Database=mydb;User Id=root;Password=pass;Pipeline=true;
```

ç®¡é“åŒ–å¯¹ INSERTã€UPDATEã€DELETE å‡æœ‰æ•ˆï¼Œæ­é…æ•°ç»„ç»‘å®šæˆ–å­—å…¸å‚æ•°é›†ä½¿ç”¨ï¼š

```csharp
// ç®¡é“åŒ– + æ•°ç»„ç»‘å®šï¼Œæ‰¹é‡ UPDATE ä¸€ä¸‡è¡Œ
var connStr = "Server=localhost;Database=mydb;User Id=root;Password=pass;Pipeline=true;";
using var conn = new MySqlConnection(connStr);
conn.Open();

using var cmd = new MySqlCommand(conn, "UPDATE users SET age=@age WHERE name=@name");
cmd.Parameters.AddWithValue("age", agesArray);    // Int32[10000]
cmd.Parameters.AddWithValue("name", namesArray);   // String[10000]
var totalAffected = cmd.ExecuteArrayBatch(10000);
```

**å·¥ä½œåŸç†**ï¼š
- é»˜è®¤æ¨¡å¼ï¼ˆPipeline=falseï¼‰ï¼šé€æ¡å‘é€è¯·æ±‚å¹¶ç­‰å¾…å“åº”ï¼Œè€—æ—¶ â‰ˆ N Ã— ç½‘ç»œå»¶è¿Ÿ
- ç®¡é“åŒ–æ¨¡å¼ï¼ˆPipeline=trueï¼‰ï¼šæ‰¹é‡å‘é€ â†’ ä¸€æ¬¡ Flush â†’ æ‰¹é‡è¯»å–ï¼Œè€—æ—¶ â‰ˆ 1 Ã— ç½‘ç»œå»¶è¿Ÿ + N Ã— æœåŠ¡å™¨å¤„ç†æ—¶é—´
- ç½‘ç»œå»¶è¿Ÿè¶Šé«˜ï¼ˆå¦‚è·¨æœºæˆ¿ï¼‰ï¼Œç®¡é“åŒ–æ”¶ç›Šè¶Šå¤§

### æ–¹æ¡ˆ Dï¼šå¤šè¡Œ INSERT VALUES

XCode å·²æ”¯æŒçš„å¤šè¡Œ INSERT è¯­æ³•ï¼Œç›´æ¥é€šè¿‡æ–‡æœ¬åè®®å‘é€ï¼š

```csharp
var sql = "INSERT INTO users(name, age) VALUES('Alice', 25), ('Bob', 30), ('Charlie', 22)";
conn.ExecuteNonQuery(sql);
```

### DbBatch APIï¼ˆ.NET 6+ï¼‰

.NET 6 åŠä»¥ä¸Šç‰ˆæœ¬æ”¯æŒ ADO.NET æ ‡å‡†çš„ `DbBatch` APIï¼š

```csharp
var batch = conn.CreateBatch();
batch.BatchCommands.Add(new MySqlBatchCommand("INSERT INTO users(name, age) VALUES('X1', 10)"));
batch.BatchCommands.Add(new MySqlBatchCommand("INSERT INTO users(name, age) VALUES('X2', 20)"));
batch.BatchCommands.Add(new MySqlBatchCommand("UPDATE users SET age = age + 1 WHERE name = 'X1'"));

using var reader = batch.ExecuteReader();
// éå†æ¯ä¸ªå‘½ä»¤çš„ç»“æœ...
```

## SSL/TLS åŠ å¯†è¿æ¥

åœ¨è¿æ¥å­—ç¬¦ä¸²ä¸­è®¾ç½® `SslMode`ï¼š

```csharp
// å¦‚æœæœåŠ¡å™¨æ”¯æŒåˆ™åŠ å¯†ï¼Œä¸æ”¯æŒåˆ™æ˜æ–‡
var connStr = "Server=localhost;Database=mydb;User Id=root;Password=pass;SslMode=Preferred;";

// å¿…é¡»åŠ å¯†ï¼ŒæœåŠ¡å™¨ä¸æ”¯æŒåˆ™æŠ›å¼‚å¸¸
var connStr2 = "Server=localhost;Database=mydb;User Id=root;Password=pass;SslMode=Required;";
```

| SslMode | è¡Œä¸º |
|---------|------|
| `None` / `Disabled` | ä¸ä½¿ç”¨ SSLï¼ˆé»˜è®¤ï¼‰ |
| `Preferred` | æœåŠ¡å™¨æ”¯æŒåˆ™ä½¿ç”¨ï¼Œä¸æ”¯æŒåˆ™æ˜æ–‡ |
| `Required` | å¿…é¡»ä½¿ç”¨ SSLï¼Œå¦åˆ™æŠ›å¼‚å¸¸ |

## Schema ä¿¡æ¯æŸ¥è¯¢

```csharp
// è·å–æ•°æ®åº“åˆ—è¡¨
var databases = conn.GetSchema("Databases");

// è·å–è¡¨åˆ—è¡¨
var tables = conn.GetSchema("Tables");

// è·å–åˆ—ä¿¡æ¯
var columns = conn.GetSchema("Columns");
```

## å¼‚æ­¥æ–¹æ³•

æ‰€æœ‰æ ¸å¿ƒæ“ä½œå‡æ”¯æŒå¼‚æ­¥ç‰ˆæœ¬ï¼š

```csharp
using var conn = new MySqlConnection(connStr);
await conn.OpenAsync();

using var cmd = new MySqlCommand(conn, "SELECT * FROM users");
using var reader = await cmd.ExecuteReaderAsync();

while (await reader.ReadAsync())
{
    Console.WriteLine(reader.GetString(0));
}
```

## è¿æ¥æ± 

è¿æ¥æ± é»˜è®¤å¯ç”¨ï¼Œæ— éœ€é¢å¤–é…ç½®ã€‚æ¯ä¸ªå”¯ä¸€çš„è¿æ¥å­—ç¬¦ä¸²å¯¹åº”ä¸€ä¸ªç‹¬ç«‹çš„è¿æ¥æ± ã€‚

- æ‰“å¼€è¿æ¥æ—¶è‡ªåŠ¨ä»æ± ä¸­è·å–ç©ºé—²è¿æ¥
- å…³é—­è¿æ¥æ—¶è‡ªåŠ¨å½’è¿˜åˆ°æ± ä¸­ï¼ˆä¸æ–­å¼€ TCP è¿æ¥ï¼‰
- æ— æ•ˆè¿æ¥ï¼ˆç½‘ç»œæ–­å¼€ç­‰ï¼‰åœ¨è·å–æ—¶è‡ªåŠ¨å‰”é™¤
- æ–°è¿æ¥æŒ‰éœ€åˆ›å»º

## åˆ‡æ¢æ•°æ®åº“

### æ–¹å¼ä¸€ï¼šé€šè¿‡ ChangeDatabaseï¼ˆæ¨èï¼‰

```csharp
using var conn = new MySqlConnection("Server=localhost;Database=db1;...");
conn.Open();

// åˆ‡æ¢æ•°æ®åº“ï¼ˆä¼šå…³é—­å¹¶é‡æ–°æ‰“å¼€è¿æ¥ï¼‰
conn.ChangeDatabase("db2");
```

**æ³¨æ„äº‹é¡¹**ï¼š
- **ä¸æ”¯æŒåœ¨äº‹åŠ¡ä¸­é€”åˆ‡æ¢**ï¼ˆäº‹åŠ¡ä¼šä¸¢å¤±ï¼‰
- æœ‰è¿æ¥å…³é—­/æ‰“å¼€çš„å¼€é”€
- æ¨èä¸ºæ¯ä¸ªæ•°æ®åº“åˆ›å»ºç‹¬ç«‹è¿æ¥å¯¹è±¡

### æ–¹å¼äºŒï¼šé€šè¿‡ SqlClient.SetDatabaseAsyncï¼ˆä½çº§ APIï¼‰

```csharp
using var conn = new MySqlConnection(connStr);
conn.Open();

// ä½¿ç”¨ COM_INIT_DB äºŒè¿›åˆ¶å‘½ä»¤åˆ‡æ¢æ•°æ®åº“ï¼ˆä¸å…³é—­è¿æ¥ï¼‰
await conn.Client.SetDatabaseAsync("information_schema");
```

**ç‰¹ç‚¹**ï¼š
- ä½¿ç”¨ MySQL COM_INIT_DB åè®®å‘½ä»¤ï¼Œç­‰æ•ˆäº `USE database`
- ä¸ä¼šå…³é—­è¿æ¥ï¼Œæ€§èƒ½ç•¥ä¼˜
- ä»…åˆ‡æ¢æœåŠ¡å™¨ç«¯å½“å‰æ•°æ®åº“ï¼Œä¸ä¼šæ›´æ–°è¿æ¥å­—ç¬¦ä¸²
- é€‚åˆä¸´æ—¶æŸ¥è¯¢åœºæ™¯ï¼Œä¸é€‚åˆè¿æ¥æ± å¤ç”¨åœºæ™¯

## ä¸ XCode ORM é›†æˆ

NewLife.MySql é€šè¿‡ `MySqlClientFactory` è‡ªåŠ¨æ³¨å†Œä¸º XCode çš„ MySQL æ•°æ®åº“é©±åŠ¨ï¼š

```csharp
using XCode.DataAccessLayer;

// æ³¨å†Œè¿æ¥å­—ç¬¦ä¸²
DAL.AddConnStr("mysql", "Server=localhost;Database=mydb;User Id=root;Password=pass;", null, "MySql");

// ä½¿ç”¨ DAL
var dal = DAL.Create("mysql");
var tables = dal.Tables;
```

## å¤šç›®æ ‡æ¡†æ¶

æ”¯æŒ `net45`ã€`net461`ã€`netstandard2.0`ã€`netstandard2.1`ã€`net6.0`ã€`net10.0`ã€‚

| æ¡†æ¶ | è¯´æ˜ |
|------|------|
| `net45` / `net461` | .NET Frameworkï¼Œå…¼å®¹è€é¡¹ç›® |
| `netstandard2.0` / `netstandard2.1` | è·¨å¹³å°å…¼å®¹ï¼Œæ”¯æŒå¼‚æ­¥ Dispose |
| `net6.0` | é¢å¤–æ”¯æŒ `DbBatch` API |
| `net10.0` | æœ€æ–° .NETï¼Œäº«å—æœ€ä¼˜æ€§èƒ½ |

## æ³¨æ„äº‹é¡¹

1. **MySQL ç‰ˆæœ¬**ï¼šæ”¯æŒ MySQL 5.x åŠä»¥ä¸Šï¼Œæ¨è MySQL 8.0+
2. **å­—ç¬¦ç¼–ç **ï¼šé»˜è®¤ä½¿ç”¨ UTF-8 ç¼–ç 
3. **ChangeDatabase ä½¿ç”¨çº¦æŸ**ï¼š
   - `ChangeDatabase` é€šè¿‡å…³é—­/é‡æ–°æ‰“å¼€è¿æ¥å®ç°æ•°æ®åº“åˆ‡æ¢
   - **ä¸æ”¯æŒåœ¨äº‹åŠ¡ä¸­é€”åˆ‡æ¢æ•°æ®åº“**ï¼ˆäº‹åŠ¡ä¼šä¸¢å¤±ï¼‰
   - ä¸å»ºè®®é¢‘ç¹è°ƒç”¨ï¼ˆæœ‰è¿æ¥å…³é—­/æ‰“å¼€å¼€é”€ï¼‰
   - æ¨èä¸ºæ¯ä¸ªæ•°æ®åº“åˆ›å»ºç‹¬ç«‹çš„è¿æ¥å¯¹è±¡

## ç›¸å…³æ–‡æ¡£

- [æ¶æ„è®¾è®¡](Doc/æ¶æ„è®¾è®¡.md) â€” æ ¸å¿ƒåŠŸèƒ½çš„æ¶æ„è®¾è®¡ä¸åè®®å®ç°ç»†èŠ‚
- [æ€§èƒ½æµ‹è¯•æŠ¥å‘Š](Doc/æ€§èƒ½æµ‹è¯•æŠ¥å‘Š.md) â€” æ‰¹é‡æ“ä½œåŸºå‡†æ€§èƒ½æµ‹è¯•æŠ¥å‘Š



