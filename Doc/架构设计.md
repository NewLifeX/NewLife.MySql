# NewLife.MySql 架构设计

## 1. 概述

NewLife.MySql 是一个轻量级高性能 MySql 驱动，基于 ADO.NET 标准接口实现，直接通过 TCP 通信实现 MySQL 协议层，无需依赖官方驱动或第三方库。

## 2. 整体架构

```
┌─────────────────────────────────────────────┐
│              应用层 (Application)             │
│  DAL / XCode / 直接使用 ADO.NET 接口          │
└─────────────────────┬───────────────────────┘
                      │
┌─────────────────────▼───────────────────────┐
│            ADO.NET 标准接口层                  │
│  MySqlConnection  MySqlCommand               │
│  MySqlDataReader  MySqlTransaction           │
│  MySqlParameter   MySqlParameterCollection   │
│  MySqlClientFactory                          │
└─────────────────────┬───────────────────────┘
                      │
┌─────────────────────▼───────────────────────┐
│              连接池层 (Pool)                   │
│  MySqlPoolManager  MySqlPool                 │
│  按连接字符串分池，复用 SqlClient 连接          │
└─────────────────────┬───────────────────────┘
                      │
┌─────────────────────▼───────────────────────┐
│            协议层 (Protocol)                   │
│  SqlClient         Authentication            │
│  SchemaProvider    WelcomeMessage             │
│  Response          MySqlColumn               │
│  BinaryHelper      ClientFlags               │
└─────────────────────┬───────────────────────┘
                      │
┌─────────────────────▼───────────────────────┐
│            网络层 (Network)                    │
│  TcpClient + NetworkStream                   │
│  SslStream (可选 TLS 加密)                    │
└─────────────────────────────────────────────┘
```

## 3. 核心类关系

### 3.1 ADO.NET 标准接口

| 类名 | 基类 | 职责 |
|------|------|------|
| `MySqlClientFactory` | `DbProviderFactory` | 工厂类，创建连接/命令/参数等对象，管理连接池 |
| `MySqlConnection` | `DbConnection` | 数据库连接，管理生命周期和状态 |
| `MySqlCommand` | `DbCommand` | SQL 命令执行，参数化查询 |
| `MySqlDataReader` | `DbDataReader` | 结果集读取，逐行读取数据 |
| `MySqlTransaction` | `DbTransaction` | 事务管理，提交/回滚 |
| `MySqlParameter` | `DbParameter` | 查询参数 |
| `MySqlParameterCollection` | `DbParameterCollection` | 参数集合 |
| `MySqlConnectionStringBuilder` | `DbConnectionStringBuilder` | 连接字符串解析 |

### 3.2 协议层

| 类名 | 职责 |
|------|------|
| `SqlClient` | 核心协议实现，管理 TCP 连接、收发数据包、协议解析 |
| `Authentication` | MySQL 认证流程（mysql_native_password / caching_sha2_password） |
| `Response` | 响应包封装，判断 OK/Error/EOF |
| `WelcomeMessage` | 握手欢迎消息解析 |
| `SchemaProvider` | Schema 信息查询（数据库/表/列/索引） |
| `MySqlColumn` | 结果集列元数据 |

### 3.3 辅助类

| 类名 | 职责 |
|------|------|
| `BinaryHelper` | MySQL 协议二进制读写扩展方法 |
| `MySqlDbType` | MySQL 数据类型枚举 |
| `ClientFlags` | 客户端能力标志位 |
| `ServerStatus` | 服务器状态标志位 |
| `DbCmd` | MySQL 命令类型枚举 |
| `MySqlException` | MySQL 异常类 |

## 4. 协议交互流程

### 4.1 连接建立

```
Client                          Server
  │                               │
  │◄──── Welcome Packet ──────────│  服务器发送欢迎消息（协议版本/能力/种子）
  │                               │
  │  [可选] SSL Request ─────────►│  如果 SslMode != None
  │◄──── TLS Handshake ──────────►│  升级为加密连接
  │                               │
  │  Auth Response ──────────────►│  发送认证信息（用户名/加密密码/数据库）
  │◄──── OK / Auth Switch ───────│  认证结果
  │                               │
  │  SHOW VARIABLES ─────────────►│  获取服务器变量配置
  │◄──── Result Set ─────────────│  max_allowed_packet / charset 等
  │                               │
```

### 4.2 查询执行

```
Client                          Server
  │                               │
  │  COM_QUERY(SQL) ─────────────►│  发送 SQL 查询
  │                               │
  │  [查询结果]                     │
  │◄──── Column Count ───────────│  列数量
  │◄──── Column Definitions ─────│  列定义 × N
  │◄──── EOF ────────────────────│  列定义结束
  │◄──── Row Data ───────────────│  行数据 × M
  │◄──── EOF ────────────────────│  结果集结束
  │                               │
  │  [非查询结果]                   │
  │◄──── OK Packet ──────────────│  affected_rows + last_insert_id
  │                               │
```

### 4.3 事务流程

```
Client                          Server
  │                               │
  │  SET TRANSACTION ... ────────►│  设置隔离级别
  │◄──── OK ─────────────────────│
  │                               │
  │  BEGIN ──────────────────────►│  开始事务
  │◄──── OK ─────────────────────│
  │                               │
  │  INSERT/UPDATE/DELETE ───────►│  业务 SQL
  │◄──── OK ─────────────────────│
  │                               │
  │  COMMIT / ROLLBACK ──────────►│  提交或回滚
  │◄──── OK ─────────────────────│
  │                               │
```

## 5. 连接池设计

```
MySqlClientFactory
  └── MySqlPoolManager（单例，管理所有连接池）
        └── MySqlPool（按连接字符串分组）
              ├── SqlClient #1 (active)
              ├── SqlClient #2 (idle)
              └── SqlClient #N ...
```

- 继承 `NewLife.Collections.ObjectPool<SqlClient>`
- 按连接字符串哈希分池，相同连接字符串共用同一个池
- 默认最小连接数 10，最大 100000
- 空闲超时 30 秒，全空闲超时 300 秒
- 获取连接时验证可用性（`Reset` 检查 + Active 状态检查）
- 归还时连接保持打开状态以便复用

## 6. 参数化查询

采用客户端参数替换方式：

1. 解析 SQL 中的 `@参数名` 标记
2. 跳过字符串字面量中的 `@`（避免误替换）
3. 根据参数值类型序列化为 SQL 字面量
4. 特殊字符转义（单引号、反斜杠、换行等）

支持的参数类型：`String`、数字类型、`DateTime`、`Boolean`、`NULL`、`Byte[]`、`Guid`、`Enum`

## 7. 认证方式

| 认证方式 | 支持版本 | 说明 |
|---------|---------|------|
| `mysql_native_password` | MySQL 5.x+ | SHA1 双重哈希 |
| `caching_sha2_password` | MySQL 8.0+ | SHA256 哈希，支持 RSA 公钥加密降级 |

## 8. 多目标框架

| 框架 | 说明 |
|------|------|
| `net45` | .NET Framework 4.5 |
| `net461` | .NET Framework 4.6.1 |
| `netstandard2.0` | .NET Standard 2.0 |
| `netstandard2.1` | .NET Standard 2.1（支持异步 Dispose、CloseAsync） |

条件编译符号：`NETFRAMEWORK`、`NET45`、`NETSTANDARD2_1_OR_GREATER`、`NET5_0_OR_GREATER`

## 9. 数据类型映射

| MySQL 类型 | .NET 类型 |
|-----------|----------|
| TINYINT / SMALLINT / INT / BIGINT | `Int64` |
| FLOAT / DOUBLE | `Double` |
| DECIMAL / NEWDECIMAL | `Decimal` |
| VARCHAR / TEXT / ENUM 等 | `String` |
| BLOB / BINARY | `Byte[]` |
| DATETIME / TIMESTAMP / DATE / TIME | `DateTime` |
| BIT | `Boolean` |
| JSON | `String` |
