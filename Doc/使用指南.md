# NewLife.MySql 使用指南

## 1. 安装

通过 NuGet 安装：
```
dotnet add package NewLife.MySql
```

或在项目文件中添加引用：
```xml
<PackageReference Include="NewLife.MySql" Version="1.0.*" />
```

## 2. 基本连接

### 2.1 连接字符串

```
Server=localhost;Port=3306;Database=mydb;User Id=root;Password=pass;
```

支持的连接字符串参数：

| 参数 | 别名 | 默认值 | 说明 |
|------|------|--------|------|
| Server | DataSource, Data Source | - | 服务器地址 |
| Port | - | 3306 | 端口号 |
| Database | - | - | 数据库名 |
| UserID | Uid, User Id, User | - | 用户名 |
| Password | Pass, Pwd | - | 密码 |
| ConnectionTimeout | Connection Timeout | 15 | 连接超时（秒） |
| CommandTimeout | Default Command Timeout | 30 | 命令超时（秒） |
| SslMode | Ssl Mode | None | SSL 模式（None/Preferred/Required） |

### 2.2 打开和关闭连接

```csharp
using var conn = new MySqlConnection("Server=localhost;Database=mydb;User Id=root;Password=pass;");
conn.Open();

// 使用连接执行操作...

conn.Close();
// 或者通过 using 自动关闭
```

### 2.3 异步打开连接

```csharp
using var conn = new MySqlConnection(connStr);
await conn.OpenAsync();
```

## 3. 执行查询

### 3.1 查询并读取结果集

```csharp
using var conn = new MySqlConnection(connStr);
conn.Open();

using var cmd = new MySqlCommand(conn, "SELECT id, name, age FROM users WHERE age > 18");
using var reader = cmd.ExecuteReader();

while (reader.Read())
{
    var id = reader.GetInt64(0);
    var name = reader.GetString(1);
    var age = reader.GetInt64(2);
    Console.WriteLine($"{id}: {name}, {age}");
}
```

### 3.2 查询单个值

```csharp
using var cmd = new MySqlCommand(conn, "SELECT COUNT(*) FROM users");
var count = cmd.ExecuteScalar();
```

### 3.3 执行非查询（INSERT/UPDATE/DELETE）

```csharp
using var cmd = new MySqlCommand(conn, "INSERT INTO users(name, age) VALUES('Tom', 25)");
var affectedRows = cmd.ExecuteNonQuery();
```

### 3.4 快捷执行

`MySqlConnection` 提供了 `ExecuteNonQuery` 快捷方法：

```csharp
var rows = conn.ExecuteNonQuery("DELETE FROM logs WHERE created < '2024-01-01'");
```

## 4. 参数化查询

使用 `@参数名` 语法绑定参数，自动进行值转义，防止 SQL 注入：

### 4.1 基本用法

```csharp
using var cmd = new MySqlCommand(conn, "SELECT * FROM users WHERE name = @name AND age > @age");
cmd.Parameters.AddWithValue("name", "Tom");
cmd.Parameters.AddWithValue("age", 18);

using var reader = cmd.ExecuteReader();
while (reader.Read())
{
    Console.WriteLine(reader.GetString(0));
}
```

### 4.2 参数化插入

```csharp
using var cmd = new MySqlCommand(conn, "INSERT INTO users(name, age, created) VALUES(@name, @age, @dt)");
cmd.Parameters.AddWithValue("name", "Alice");
cmd.Parameters.AddWithValue("age", 30);
cmd.Parameters.AddWithValue("dt", DateTime.Now);
var rows = cmd.ExecuteNonQuery();
```

### 4.3 NULL 值

```csharp
cmd.Parameters.AddWithValue("email", DBNull.Value);
```

### 4.4 支持的参数类型

| .NET 类型 | SQL 字面量示例 |
|-----------|---------------|
| `String` | `'hello'`（自动转义特殊字符） |
| `Int32` / `Int64` 等数字 | `42` |
| `Boolean` | `1` 或 `0` |
| `DateTime` | `'2025-07-01 12:30:00'` |
| `Byte[]` | `X'CAFE'` |
| `Guid` | `'01234567-89ab-cdef-...'` |
| `Enum` | 转为数字 |
| `null` / `DBNull.Value` | `NULL` |

## 5. 事务

### 5.1 基本事务

```csharp
using var conn = new MySqlConnection(connStr);
conn.Open();

using var tr = conn.BeginTransaction();
try
{
    conn.ExecuteNonQuery("INSERT INTO orders(product, qty) VALUES('Widget', 10)");
    conn.ExecuteNonQuery("UPDATE inventory SET qty = qty - 10 WHERE product = 'Widget'");
    tr.Commit();
}
catch
{
    tr.Rollback();
    throw;
}
```

### 5.2 隔离级别

```csharp
using var tr = conn.BeginTransaction(IsolationLevel.ReadCommitted);
```

支持的隔离级别：
- `ReadUncommitted`
- `ReadCommitted`
- `RepeatableRead`（默认）
- `Serializable`

### 5.3 自动回滚

事务 `Dispose` 时如果未提交也未回滚，会自动执行回滚：

```csharp
using (var tr = conn.BeginTransaction())
{
    conn.ExecuteNonQuery("INSERT INTO ...");
    // 忘记 Commit/Rollback —— Dispose 时自动回滚
}
```

## 6. SSL/TLS 加密连接

在连接字符串中设置 `SslMode`：

```csharp
// 如果服务器支持则加密，不支持则明文
var connStr = "Server=localhost;Database=mydb;User Id=root;Password=pass;SslMode=Preferred;";

// 必须加密，服务器不支持则抛异常
var connStr2 = "Server=localhost;Database=mydb;User Id=root;Password=pass;SslMode=Required;";
```

| SslMode | 行为 |
|---------|------|
| `None` / `Disabled` | 不使用 SSL（默认） |
| `Preferred` | 服务器支持则使用，不支持则明文 |
| `Required` | 必须使用 SSL，否则抛异常 |

## 7. Schema 信息查询

```csharp
using var conn = new MySqlConnection(connStr);
conn.Open();

// 获取所有集合
var collections = conn.GetSchema();

// 获取数据库列表
var databases = conn.GetSchema("Databases");

// 获取表列表
var tables = conn.GetSchema("Tables");

// 获取列信息
var columns = conn.GetSchema("Columns");
```

## 8. 与 XCode ORM 集成

NewLife.MySql 通过 `MySqlClientFactory` 自动注册为 XCode 的 MySQL 数据库驱动：

```csharp
using XCode.DataAccessLayer;

// 注册连接字符串
DAL.AddConnStr("mysql", "Server=localhost;Database=mydb;User Id=root;Password=pass;", null, "MySql");

// 使用 DAL
var dal = DAL.Create("mysql");
var tables = dal.Tables;
```

## 9. 连接池

连接池默认启用，无需额外配置。每个唯一的连接字符串对应一个独立的连接池。

连接池行为：
- 打开连接时自动从池中获取空闲 `SqlClient`
- 关闭连接时自动归还到池中（不断开 TCP 连接）
- 无效连接（网络断开等）在获取时自动剔除
- 新连接按需创建

## 10. 异步方法

所有核心操作均支持异步版本：

```csharp
using var conn = new MySqlConnection(connStr);
await conn.OpenAsync();

using var cmd = new MySqlCommand(conn, "SELECT * FROM users");
using var reader = await cmd.ExecuteReaderAsync();

while (await reader.ReadAsync())
{
    Console.WriteLine(reader.GetString(0));
}

var count = await cmd.ExecuteScalarAsync();
var rows = await cmd.ExecuteNonQueryAsync();
```

## 11. 注意事项

1. **多语句查询**：暂不支持用分号分隔的多条 SQL 语句，请分开执行
2. **存储过程**：暂不支持，计划后续版本实现
3. **批量操作**：暂不支持，计划后续版本实现
4. **MySQL 版本**：支持 MySQL 5.x 及以上，推荐 MySQL 8.0+
5. **字符编码**：默认使用 UTF-8 编码
